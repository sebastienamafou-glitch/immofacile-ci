// ==========================================
// CONFIGURATION GLOBALE
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Ou "mysql" selon ta config
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. GESTION UTILISATEURS UNIFIÉE (IAM)
// ==========================================

model User {
  id            String    @id @default(cuid())
  
  // --- Identité de base ---
  email         String?   @unique
  phone         String?   @unique
  name          String?
  password      String?   // Haché
  image         String?   // Avatar
  
  // --- Sécurité & Verification ---
  emailVerified DateTime?
  phoneVerified DateTime?
  isVerified    Boolean   @default(false)
  kycStatus     VerificationStatus @default(PENDING)
  kycDocuments  String[]  
  
  // --- Rôles & Métier ---
  role          Role      @default(GUEST)
  
  // Infos Profil (ImmoFacile)
  jobTitle      String?   
  address       String?
  income        Int?      // Revenus mensuels
  paymentMethod String?   // WAVE, OM...
  paymentNumber String?   // 07xx...
  isAvailable   Boolean   @default(false) 

  // --- Fintech / Wallet (ImmoFacile) ---
  walletBalance   Int     @default(0)
  escrowBalance   Int     @default(0) 
  referralBalance Int     @default(0)

  // --- Module Investisseur (CROWDFUNDING) ---
  isBacker        Boolean @default(false)
  backerTier      String? // "SUPPORTER", "AMBASSADEUR", "VISIONNAIRE"
  
  // --- Relations (NextAuth) ---
  accounts      Account[]
  sessions      Session[]

  // --- Relations Métier (Longue Durée) ---
  propertiesOwned    Property[]      @relation("PropertyOwner")
  leases             Lease[]         
  missionsAccepted   Mission[]       @relation("AgentMissions")
  leads              Lead[]
  incidentsReported  Incident[]      @relation("IncidentReporter")
  incidentsAssigned  Incident[]      @relation("ArtisanIncidents")
  transactions       Transaction[]
  
  // ✅ CORRECTION CLEAN CODE : Séparation des responsabilités
  signatureProofs    SignatureProof[] // Pour les Baux (Technique)
  investmentContracts InvestmentContract[] // Pour les Investisseurs (Juridique)

  // --- Relations Métier (Courte Durée) ---
  listings           Listing[]       
  bookings           Booking[]       
  reviews            Review[]        
  wishlists          Wishlist[]
  sentMessages       Message[]
  conversationsAsGuest Conversation[] @relation("GuestConversations")
  conversationsAsHost  Conversation[] @relation("HostConversations")
  
  // --- Multi-Tenant SaaS (Agence) ---
  agencyId           String?
  agency             Agency?         @relation(fields: [agencyId], references: [id])

  lastMessageAt      DateTime        @default(now())
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
}

// ==========================================
// 2. MODÈLE AGENCE (SaaS B2B)
// ==========================================

model Agency {
  id           String   @id @default(cuid())
  name         String   @unique
  slug         String   @unique 
  logoUrl      String?
  email        String?  
  phone        String?
  primaryColor String?  @default("#FF7900") 
  taxId        String?
  isActive     Boolean  @default(false) 

  users        User[]   
  listings     Listing[] 
  properties   Property[] 

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ==========================================
// 3. AUTHENTIFICATION TECHNIQUE (NextAuth)
// ==========================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==========================================
// 4. PATRIMOINE PHYSIQUE (Long Terme)
// ==========================================

model Property {
  id          String   @id @default(cuid())
  title       String
  description String?
  address     String
  commune     String
  price       Int      
  type        PropertyType
  bedrooms    Int
  bathrooms   Int
  surface     Float?
  images      String[]
  isPublished Boolean  @default(true)
  
  ownerId     String
  owner       User     @relation("PropertyOwner", fields: [ownerId], references: [id])
  
  leases      Lease[]
  incidents   Incident[]
  missions    Mission[]
  inventories Inventory[]

  agencyId    String?
  agency      Agency?  @relation(fields: [agencyId], references: [id])

  listings    Listing[] 

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==========================================
// 5. GESTION LOCATIVE (Baux)
// ==========================================

model Lease {
  id              String          @id @default(cuid())
  startDate       DateTime
  endDate         DateTime?
  monthlyRent     Int
  depositAmount   Int
  status          LeaseStatus     @default(PENDING)
  isActive        Boolean         @default(false)
  
  contractUrl     String?
  documentHash    String?
  signatureStatus SignatureStatus @default(PENDING)
  
  tenantId        String
  tenant          User            @relation(fields: [tenantId], references: [id])
  propertyId      String
  property        Property        @relation(fields: [propertyId], references: [id])
  
  payments        Payment[]
  signatures      SignatureProof[]
  inventories     Inventory[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model Inventory {
  id          String        @id @default(cuid())
  date        DateTime      @default(now())
  type        MissionType   
  notes       String?
  reportUrl   String?
  
  leaseId     String
  lease       Lease         @relation(fields: [leaseId], references: [id])
  propertyId  String
  property    Property      @relation(fields: [propertyId], references: [id])
  agentId     String?
  
  items       InventoryItem[]
}

model InventoryItem {
  id          String   @id @default(cuid())
  roomName    String   
  element     String   
  condition   String   
  comment     String?
  photos      String[]
  
  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id])
}

// Preuves de signature pour les BAUX (Contexte Location)
model SignatureProof {
  id        String   @id @default(cuid())
  ipAddress String
  signedAt  DateTime @default(now())
  userAgent String?
  
  signatureData String?  @db.Text
  otpToken  String?
  
  // Liaison stricte avec le bail
  leaseId   String
  lease     Lease    @relation(fields: [leaseId], references: [id])

  // Le signataire (Locataire ou Propriétaire)
  signerId  String
  signer    User     @relation(fields: [signerId], references: [id])
  
  documentType String   @default("LEASE")
}

// ✅ NOUVEAU : Preuves de signature pour les INVESTISSEURS (Contexte Crowdfunding)
model InvestmentContract {
  id            String   @id @default(cuid())
  signedAt      DateTime @default(now())
  
  // Preuves techniques (Loi 2013-546)
  ipAddress     String
  userAgent     String?
  signatureData String   @db.Text // L'image Base64
  
  // Liaison directe avec l'investisseur
  userId        String
  user          User     @relation(fields: [userId], references: [id])

  // Métadonnées du contrat figées à la signature
  packName      String?  // "VISIONNAIRE", etc.
  amount        Int      // Le montant engagé
}

// ==========================================
// 6. COURT SÉJOUR (Airbnb-like)
// ==========================================

model Listing {
  id             String   @id @default(cuid())
  title          String
  description    String   @db.Text
  pricePerNight  Int      
  
  address        String
  city           String
  neighborhood   String?
  latitude       Float?
  longitude      Float?
  landmark       String?
  bedrooms       Int      @default(1)
  bathrooms      Int      @default(1)
  maxGuests      Int      @default(2)
  
  images         String[]
  amenities      Json     
  accessVideoUrl String?

  isPublished    Boolean  @default(false)

  hostId         String
  host           User     @relation(fields: [hostId], references: [id])
  
  agencyId       String?
  agency         Agency?  @relation(fields: [agencyId], references: [id])

  propertyId     String?
  property       Property? @relation(fields: [propertyId], references: [id])
  
  bookings       Booking[]
  reviews        Review[]
  wishlists      Wishlist[]       
  conversations  Conversation[]   

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Booking {
  id          String        @id @default(cuid())
  startDate   DateTime
  endDate     DateTime
  totalPrice  Int
  status      BookingStatus @default(PENDING)

  guestId     String
  guest       User          @relation(fields: [guestId], references: [id])
  listingId   String
  listing     Listing       @relation(fields: [listingId], references: [id])

  payment     BookingPayment?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id])
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  createdAt DateTime @default(now())
}

// ==========================================
// 7. FINANCE & PAIEMENTS
// ==========================================

// Paiements Loyers
model Payment {
  id             String        @id @default(cuid())
  amount         Int          
  date           DateTime      @default(now())
  type           PaymentType
  status         PaymentStatus @default(PENDING)
  method         String?       // WAVE, OM...
  reference      String?

  amountOwner    Int           @default(0)
  amountPlatform Int           @default(0)
  amountAgent    Int           @default(0)

  leaseId        String
  lease          Lease         @relation(fields: [leaseId], references: [id])
}

// Paiements Réservations
model BookingPayment {
  id               String          @id @default(cuid())
  amount           Int
  provider         PaymentProvider 
  transactionId    String          @unique
  status           String
  
  agencyCommission Int
  hostPayout       Int

  bookingId        String          @unique
  booking          Booking         @relation(fields: [bookingId], references: [id])

  createdAt        DateTime        @default(now())
}

// Transactions Génériques (Wallet / Crowdfunding)
model Transaction {
  id          String   @id @default(cuid())
  amount      Int
  type        String   // "CREDIT" | "DEBIT"
  reason      String   // Ex: "CROWDFUNDING_PACK_GOLD"
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
}

// ==========================================
// 8. OPÉRATIONS & MAINTENANCE
// ==========================================

model Mission {
  id            String        @id @default(cuid())
  type          MissionType
  status        MissionStatus @default(PENDING)
  fee           Int
  dateScheduled DateTime?
  reportData    String?
  
  propertyId    String
  property      Property      @relation(fields: [propertyId], references: [id])
  agentId       String?
  agent         User?         @relation("AgentMissions", fields: [agentId], references: [id])

  createdAt     DateTime      @default(now())
}

model Incident {
  id          String         @id @default(cuid())
  title       String
  description String
  priority    String         @default("NORMAL")
  photos      String[]
  status      IncidentStatus @default(OPEN)
  
  quoteAmount Int?
  finalCost   Int?
  
  reporterId  String
  reporter    User           @relation("IncidentReporter", fields: [reporterId], references: [id])
  
  assignedToId String?
  assignedTo   User?         @relation("ArtisanIncidents", fields: [assignedToId], references: [id])

  propertyId  String
  property    Property       @relation(fields: [propertyId], references: [id])

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model Lead {
  id        String   @id @default(cuid())
  name      String
  phone     String
  needs     String?
  budget    Int?
  status    String   @default("NEW")
  
  agentId   String?
  agent     User?    @relation(fields: [agentId], references: [id])

  createdAt DateTime @default(now())
}

// ==========================================
// 9. MESSAGERIE & COMMUNAUTÉ
// ==========================================

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, listingId]) 
}

model Conversation {
  id        String    @id @default(cuid())
  
  guestId   String
  guest     User      @relation("GuestConversations", fields: [guestId], references: [id])
  hostId    String
  host      User      @relation("HostConversations", fields: [hostId], references: [id])
  
  listingId String?   
  listing   Listing?  @relation(fields: [listingId], references: [id])

  messages  Message[]
  lastMessageAt DateTime @default(now())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Message {
  id             String       @id @default(cuid())
  content        String       @db.Text
  isRead         Boolean      @default(false)
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id])
  createdAt      DateTime     @default(now())
}

// ==========================================
// ENUMS UNIFIÉS
// ==========================================

enum Role {
  SUPER_ADMIN
  AGENCY_ADMIN
  ADMIN
  OWNER
  TENANT
  GUEST
  AGENT
  ARTISAN
  INVESTOR      // ✅ RÔLE INVESTISSEUR
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum SignatureStatus {
  PENDING
  SIGNED_TENANT
  SIGNED_OWNER
  COMPLETED
}

enum PropertyType {
  APPARTEMENT
  VILLA
  STUDIO
  MAGASIN
  BUREAU
  TERRAIN
}

enum LeaseStatus {
  PENDING
  ACTIVE
  TERMINATED
  CANCELLED
}

enum BookingStatus {
  PENDING
  PAID
  CONFIRMED
  CHECKED_IN 
  COMPLETED
  CANCELLED
  DISPUTED
}

enum PaymentType {
  LOYER
  DEPOSIT
  CHARGES
  FEE
}

enum PaymentProvider {
  WAVE
  ORANGE_MONEY
  MTN_MOMO
  MOOV_MONEY
  STRIPE
  CASH
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum IncidentStatus {
  OPEN
  IN_PROGRESS
  QUOTATION
  RESOLVED
  CLOSED
}

enum MissionStatus {
  PENDING
  ACCEPTED
  COMPLETED
  CANCELLED
}

enum MissionType {
  VISITE
  ETAT_DES_LIEUX_ENTREE
  ETAT_DES_LIEUX_SORTIE
  PHOTOS
}
