// ==========================================
// CONFIGURATION GLOBALE
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. GESTION UTILISATEURS (IAM - Identit√© Pure)
// ==========================================

model User {
  id String @id @default(cuid())

  // --- Identit√© Publique/Semi-Publique ---
  email    String? @unique
  phone    String? @unique
  name     String?
  password String? // Hach√©
  image    String? // Photo de profil

  // --- M√©ta-donn√©es ---
  emailVerified DateTime?
  phoneVerified DateTime?
  isVerified    Boolean   @default(false)
  role          Role      @default(GUEST)

  // --- Profil Public ---
  jobTitle    String?
  address     String?
  bio         String? @db.Text
  isAvailable Boolean @default(false)

  // --- Pr√©f√©rences ---
  notifEmail Boolean @default(true)
  notifSms   Boolean @default(true)

  // --- Relations S√©curis√©es (One-to-One) ---
  finance UserFinance?
  kyc     UserKYC?

  // --- Module Investisseur ---
  isBacker   Boolean @default(false)
  backerTier String? // "SUPPORTER", "AMBASSADEUR", "VISIONNAIRE"

  // --- Relations NextAuth ---
  accounts Account[]
  sessions Session[]

  // --- Relations M√©tier ---
  propertiesOwned  Property[] @relation("PropertyOwner")
  leases           Lease[]    @relation("LeaseTenant")
  leasesManaged    Lease[]    @relation("LeaseAgent")
  missionsAccepted Mission[]  @relation("AgentMissions")

  leads               Lead[]
  incidentsReported   Incident[]           @relation("IncidentReporter")
  incidentsAssigned   Incident[]           @relation("ArtisanIncidents")
  quotesIssued        Quote[]
  transactions        Transaction[]
  signatureProofs     SignatureProof[]
  investmentContracts InvestmentContract[]
  listings            Listing[]
  bookings            Booking[]

  reviews              Review[]
  wishlists            Wishlist[]
  sentMessages         Message[]
  conversationsAsGuest Conversation[] @relation("GuestConversations")
  conversationsAsHost  Conversation[] @relation("HostConversations")

  // --- Multi-Tenant SaaS ---
  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id])

  isActive      Boolean  @default(true)
  lastMessageAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  notifications Notification[]
  auditLogs     AuditLog[]
}

// ==========================================
// 1.1 SEGMENT FINANCIER (Conformit√© BCEAO)
// ==========================================
model UserFinance {
  id String @id @default(cuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  walletBalance   Int @default(0)
  escrowBalance   Int @default(0)
  referralBalance Int @default(0)

  // CONFORMIT√â : Gestion des plafonds UEMOA
  kycTier       Int      @default(1) // Tier 1 (Basique), Tier 2 (ID V√©rifi√©), Tier 3 (Full)
  monthlyVolume Int      @default(0) // Cumul des transactions du mois
  lastResetDate DateTime @default(now()) // Pour r√©initialiser le volume mensuel

  income        Int? // Revenus mensuels d√©clar√©s
  paymentMethod String? // WAVE, OM...
  paymentNumber String? // 07xx... (√Ä masquer dans l'UI)

  // S√âCURIT√â : Verrouillage optimiste (Race Conditions)
  version Int @default(0)

  updatedAt DateTime @updatedAt
}

// ==========================================
// 1.2 SEGMENT KYC (Lutte Anti-Blanchiment)
// ==========================================
model UserKYC {
  id String @id @default(cuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status    VerificationStatus @default(PENDING)
  documents String[] // URLs sign√©es uniquement

  // CONFORMIT√â : D√©tails de la pi√®ce d'identit√©
  idType     String? // CNI, PASSPORT, VOTE_CARD
  idNumber   String? // Num√©ro de pi√®ce (Hash√©/Chiffr√©)
  expiryDate DateTime? // Date d'expiration de la pi√®ce

  reviewedBy      String? // Admin ID
  reviewedAt      DateTime?
  rejectionReason String?
  updatedAt       DateTime  @updatedAt
}

// ==========================================
// 2. MOD√àLE AGENCE (SaaS B2B)
// ==========================================

model Agency {
  id           String  @id @default(cuid())
  name         String  @unique
  code         String  @unique
  slug         String  @unique
  logoUrl      String?
  email        String?
  phone        String?
  primaryColor String? @default("#FF7900")
  taxId        String? // Num√©ro IFU / NINEA
  isActive     Boolean @default(false)

  walletBalance Int @default(0)

  users        User[]
  listings     Listing[]
  properties   Property[]
  transactions AgencyTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  defaultCommissionRate Float @default(0.10)
}

// ==========================================
// 3. AUTHENTIFICATION TECHNIQUE (NextAuth)
// ==========================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==========================================
// 4. PATRIMOINE PHYSIQUE
// ==========================================

model Property {
  id          String       @id @default(cuid())
  title       String
  description String?
  address     String
  commune     String
  price       Int
  type        PropertyType
  bedrooms    Int
  bathrooms   Int
  surface     Float?
  images      String[]
  isPublished Boolean      @default(true)
  isAvailable Boolean      @default(true)

  ownerId String
  owner   User   @relation("PropertyOwner", fields: [ownerId], references: [id])

  leases      Lease[]
  incidents   Incident[]
  missions    Mission[]
  inventories Inventory[]

  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id])

  listings     Listing[]
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([commune])
  @@index([price])
  @@index([type])
  @@index([commune, price]) // Pour les recherches type "Villas √† moins de X millions"
}

// ==========================================
// 5. GESTION LOCATIVE (Baux)
// ==========================================

model Lease {
  id            String      @id @default(cuid())
  startDate     DateTime
  endDate       DateTime?
  monthlyRent   Int
  depositAmount Int
  status        LeaseStatus @default(PENDING)
  isActive      Boolean     @default(false)

  contractUrl     String?
  documentHash    String? // Empreinte pour preuve l√©gale
  signatureStatus SignatureStatus @default(PENDING)

  tenantId String
  tenant   User   @relation("LeaseTenant", fields: [tenantId], references: [id])

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id])

  agentId String?
  agent   User?   @relation("LeaseAgent", fields: [agentId], references: [id])

  payments    Payment[]
  signatures  SignatureProof[]
  inventories Inventory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agencyCommissionRate Float?
}

model Inventory {
  id        String      @id @default(cuid())
  date      DateTime    @default(now())
  type      MissionType
  notes     String?
  reportUrl String?

  leaseId    String
  lease      Lease    @relation(fields: [leaseId], references: [id])
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id])

  agentId String?
  items   InventoryItem[]
}

model InventoryItem {
  id        String   @id @default(cuid())
  roomName  String
  element   String
  condition String
  comment   String?
  photos    String[]

  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id])
}

model SignatureProof {
  id            String   @id @default(cuid())
  ipAddress     String
  signedAt      DateTime @default(now())
  userAgent     String?
  signatureData String?  @db.Text
  otpToken      String?
  leaseId       String
  lease         Lease    @relation(fields: [leaseId], references: [id])

  signerId String
  signer   User   @relation(fields: [signerId], references: [id])

  documentType String @default("LEASE")
}

model InvestmentContract {
  id       String   @id @default(cuid())
  signedAt DateTime @default(now())

  ipAddress     String
  userAgent     String?
  signatureData String  @db.Text

  paymentReference String? @unique
  status           String  @default("PENDING")

  userId String
  user   User   @relation(fields: [userId], references: [id])

  packName String?
  amount   Int
}

// ==========================================
// 6. COURT S√âJOUR (Airbnb-like)
// ==========================================

model Listing {
  id            String @id @default(cuid())
  title         String
  description   String @db.Text
  pricePerNight Int

  address      String
  city         String
  neighborhood String?
  latitude     Float?
  longitude    Float?
  landmark     String?
  bedrooms     Int     @default(1)
  bathrooms    Int     @default(1)
  maxGuests    Int     @default(2)

  images         String[]
  amenities      Json
  accessVideoUrl String?
  isPublished    Boolean  @default(false)

  hostId String
  host   User   @relation(fields: [hostId], references: [id])

  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id])

  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id])

  bookings      Booking[]
  reviews       Review[]
  wishlists     Wishlist[]
  conversations Conversation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([city])
  @@index([pricePerNight])
  @@index([city, pricePerNight]) // Pour les recherches type "Studio √† Abidjan √† moins de 50k"
}

model Booking {
  id         String        @id @default(cuid())
  startDate  DateTime
  endDate    DateTime
  totalPrice Int
  status     BookingStatus @default(PENDING)

  guestId   String
  guest     User    @relation(fields: [guestId], references: [id])
  listingId String
  listing   Listing @relation(fields: [listingId], references: [id])

  payment   BookingPayment?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  guestCount Int           @default(1)

  @@unique([listingId, startDate])
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id])
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  createdAt DateTime @default(now())
}

// ==========================================
// 7. FINANCE & PAIEMENTS (Audit Trail)
// ==========================================

model Payment {
  id             String        @id @default(cuid())
  amount         Int
  date           DateTime      @default(now())
  type           PaymentType
  status         PaymentStatus @default(PENDING)
  method         String?
  reference      String?       @unique
  idempotencyKey String?       @unique

  // Ventilation
  amountOwner    Int @default(0)
  amountPlatform Int @default(0)
  amountAgent    Int @default(0)
  amountAgency   Int @default(0)

  platformTaxRate   Float @default(0.18)
  platformTaxAmount Int   @default(0)

  providerResponse Json?

  // üëá MODIFICATIONS APPORT√âES üëá
  leaseId String? // Devenu Optionnel (?)
  lease   Lease?  @relation(fields: [leaseId], references: [id])

  quoteId String? // Ajout√©
  quote   Quote?  @relation(fields: [quoteId], references: [id])
}

model BookingPayment {
  id            String          @id @default(cuid())
  amount        Int
  provider      String
  transactionId String          @unique
  status        String

  agencyCommission   Int
  hostPayout         Int
  platformCommission Int @default(0)

  bookingId String  @unique
  booking   Booking @relation(fields: [bookingId], references: [id])

  createdAt DateTime @default(now())
}

model Transaction {
  id          String          @id @default(cuid())
  amount      Int
  type        TransactionType // Enum CREDIT/DEBIT
  balanceType BalanceType // Quel solde est touch√© (WALLET/ESCROW)
  reason      String
  status      String          @default("SUCCESS")
  reference   String?         @unique // Liaison vers Payment.reference

  userId String
  user   User   @relation(fields: [userId], references: [id])

  // S√âCURIT√â : Audit Trail
  previousHash String? // Pour d√©tecter les alt√©rations de DB

  // ‚úÖ AJOUTS STRAT√âGIQUES POUR LA MAINTENANCE
  quoteId String?
  quote   Quote?  @relation(fields: [quoteId], references: [id])

  incidentId String?
  incident   Incident? @relation(fields: [incidentId], references: [id])

  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id])

  createdAt DateTime @default(now())
}

model AgencyTransaction {
  id     String @id @default(cuid())
  amount Int
  type   String
  reason String
  status String @default("SUCCESS")

  agencyId String
  agency   Agency @relation(fields: [agencyId], references: [id])

  createdAt DateTime @default(now())
}

// ==========================================
// 8. OP√âRATIONS & MAINTENANCE
// ==========================================

model Mission {
  id            String        @id @default(cuid())
  type          MissionType
  status        MissionStatus @default(PENDING)
  fee           Int
  dateScheduled DateTime?
  reportData    String?

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id])
  agentId    String?
  agent      User?    @relation("AgentMissions", fields: [agentId], references: [id])

  createdAt DateTime @default(now())
}

model Incident {
  id          String @id @default(cuid())
  title       String
  description String
  priority    String @default("NORMAL")

  photos       String[]
  photosBefore String[]
  photosAfter  String[]

  status IncidentStatus @default(OPEN)

  quote       Quote?
  quoteAmount Int?
  finalCost   Int?

  reporterId String
  reporter   User   @relation("IncidentReporter", fields: [reporterId], references: [id])

  assignedToId String?
  assignedTo   User?   @relation("ArtisanIncidents", fields: [assignedToId], references: [id])

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id])

  conversation Conversation?
  transactions Transaction[] // ‚úÖ Relation pour suivre les co√ªts

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Lead {
  id     String  @id @default(cuid())
  name   String
  phone  String
  needs  String?
  budget Int?
  status String  @default("NEW")

  agentId String?
  agent   User?   @relation(fields: [agentId], references: [id])

  createdAt DateTime @default(now())
}

// ==========================================
// 9. MESSAGERIE & COMMUNAUT√â
// ==========================================

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, listingId])
}

model Conversation {
  id String @id @default(cuid())

  guestId String?
  guest   User?   @relation("GuestConversations", fields: [guestId], references: [id])

  hostId String?
  host   User?   @relation("HostConversations", fields: [hostId], references: [id])

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id])

  incidentId String?   @unique
  incident   Incident? @relation(fields: [incidentId], references: [id])

  messages Message[]

  lastMessageAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Message {
  id             String       @id @default(cuid())
  content        String       @db.Text
  isRead         Boolean      @default(false)
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId  String
  sender    User     @relation(fields: [senderId], references: [id])
  createdAt DateTime @default(now())
}

// ==========================================
// 10. MODULE DEVIS & FACTURATION (ARTISAN)
// ==========================================

model Quote {
  id     String      @id @default(cuid())
  number String      @unique
  status QuoteStatus @default(PENDING)

  totalNet    Int
  taxAmount   Int @default(0)
  totalAmount Int

  validityDate DateTime
  notes        String?  @db.Text

  items QuoteItem[]

  incidentId String   @unique
  incident   Incident @relation(fields: [incidentId], references: [id])

  artisanId String
  artisan   User   @relation(fields: [artisanId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions Transaction[] // ‚úÖ Relation pour savoir si le devis a √©t√© pay√©
  payments     Payment[]
}

model QuoteItem {
  id          String @id @default(cuid())
  description String
  quantity    Int    @default(1)
  unitPrice   Int
  total       Int

  quoteId String
  quote   Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)
}

model Notification {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title   String
  message String
  isRead  Boolean @default(false)
  type    String  @default("INFO")
  link    String? // Lien de redirection

  createdAt DateTime @default(now())
}

// ==========================================
// 12. SYST√àME D'AUDIT & S√âCURIT√â
// ==========================================

model AuditLog {
  id          String   @id @default(cuid())
  action      String?   // Ex: "KYC_VALIDATED", "PAYMENT_RECEIVED", "USER_DELETED"
  entityId    String?  // L'ID de l'objet touch√© (ex: ID du Booking ou du User)
  entityType  String?  // Ex: "BOOKING", "USER", "PAYMENT"
  
  userId      String?   // Celui qui a fait l'action (Admin, System ou User)
  userEmail   String?  // Snapshot de l'email (au cas o√π le user est supprim√© plus tard)
  
  metadata    Json?    // D√©tails techniques (ex: { oldStatus: "PENDING", newStatus: "VERIFIED" })
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())

  // Relation optionnelle vers le User (si vous voulez faire des joins)
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
}

// ==========================================
// 11. ENUMS (R√âF√âRENTIEL FINANCIER)
// ==========================================

enum TransactionType {
  CREDIT
  DEBIT
  REFUND
  PAYMENT
  INVESTMENT
}

enum BalanceType {
  WALLET
  ESCROW
  REFERRAL
}

enum QuoteStatus {
  PENDING
  ACCEPTED
  REJECTED
  PAID
}

enum Role {
  SUPER_ADMIN
  AGENCY_ADMIN
  ADMIN
  OWNER
  TENANT
  GUEST
  AGENT
  ARTISAN
  INVESTOR
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum SignatureStatus {
  PENDING
  SIGNED_TENANT
  SIGNED_OWNER
  COMPLETED
}

enum PropertyType {
  APPARTEMENT
  VILLA
  STUDIO
  MAGASIN
  BUREAU
  TERRAIN
}

enum LeaseStatus {
  PENDING
  ACTIVE
  TERMINATED
  CANCELLED
}

enum BookingStatus {
  PENDING
  PAID
  CONFIRMED
  CHECKED_IN
  COMPLETED
  CANCELLED
  DISPUTED
}

enum PaymentType {
  LOYER
  DEPOSIT
  CHARGES
  FEE
  TOPUP
}

enum PaymentProvider {
  WAVE
  ORANGE_MONEY
  MTN_MOMO
  MOOV_MONEY
  STRIPE
  CASH
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum IncidentStatus {
  OPEN
  IN_PROGRESS
  QUOTATION
  RESOLVED
  CLOSED
}

enum MissionStatus {
  PENDING
  ACCEPTED
  COMPLETED
  CANCELLED
}

enum MissionType {
  VISITE
  ETAT_DES_LIEUX_ENTREE
  ETAT_DES_LIEUX_SORTIE
  PHOTOS
}
