// ==========================================
// CONFIGURATION GLOBALE
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. GESTION UTILISATEURS UNIFIÉE (IAM)
// ==========================================

// Le modèle User combine ImmoFacile (Métier) et NextAuth (Connexion Sociale)
model User {
  id            String    @id @default(cuid())
  
  // --- Identité de base ---
  email         String?   @unique
  phone         String?   @unique
  name          String?
  password      String?   // Haché (Supporte Login classique + NextAuth)
  image         String?   // Avatar
  
  // --- Sécurité & Verification ---
  emailVerified DateTime?
  phoneVerified DateTime?
  isVerified    Boolean   @default(false)
  kycStatus     VerificationStatus @default(PENDING)
  kycDocuments  String[]  // URLs CNI/Passeport
  
  // --- Rôles & Métier ---
  role          Role      @default(GUEST)
  
  // Infos Profil (ImmoFacile)
  address       String?
  jobTitle      String?   // Profession
  income        Int?      // Revenus mensuels
  paymentMethod String?   // WAVE, OM...
  paymentNumber String?   // 07xx...
  isAvailable   Boolean   @default(false) // Pour les artisans/agents

  // --- Fintech / Wallet (ImmoFacile) ---
  walletBalance   Int     @default(0)
  escrowBalance   Int     @default(0) // Caution bloquée
  referralBalance Int     @default(0)

  // --- Relations (NextAuth) ---
  accounts      Account[]
  sessions      Session[]

  // --- Relations Métier (Longue Durée - ImmoFacile) ---
  propertiesOwned    Property[]      @relation("PropertyOwner")
  leases             Lease[]         // En tant que locataire
  missionsAccepted   Mission[]       @relation("AgentMissions")
  leads              Lead[]
  incidentsReported  Incident[]      @relation("IncidentReporter")
  incidentsAssigned  Incident[]      @relation("ArtisanIncidents")
  transactions       Transaction[]
  signatureProofs    SignatureProof[]

  // --- Relations Métier (Courte Durée - Akwaba) ---
  listings           Listing[]       // Propriétés mises en location courte durée
  bookings           Booking[]       // Voyages effectués en tant que Guest
  reviews            Review[]        // Avis laissés

  // ✅ AJOUTS GUEST :
  wishlists          Wishlist[]
  sentMessages       Message[]
  conversationsAsGuest Conversation[] @relation("GuestConversations")
  conversationsAsHost  Conversation[] @relation("HostConversations")
  
  // --- Multi-Tenant SaaS (Agence) ---
  agencyId           String?
  agency             Agency?         @relation(fields: [agencyId], references: [id])

  lastMessageAt      DateTime        @default(now())

  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
}

// --- Modèle Agence (Ex-Tenant du fichier B) ---
// Représente une structure pro (Agence Immobilière) qui utilise votre SaaS
model Agency {
  id           String   @id @default(cuid())
  name         String   @unique
  slug         String   @unique // sous-domaine (ex: orpi.immofacile.ci)
  logoUrl      String?
  email        String?  // Email public de l'agence
  phone        String?  // Standard téléphonique de l'agence
  primaryColor String?  @default("#FF7900") // Orange CI par défaut
  taxId        String?  // N° Compte Contribuable
  isActive     Boolean  @default(false) // Validation par SuperAdmin requise

  users        User[]   // Agents et Admins de cette agence
  listings     Listing[] // Leurs annonces
  properties   Property[] // Leur parc immobilier

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ==========================================
// 2. AUTHENTIFICATION TECHNIQUE (NextAuth)
// ==========================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==========================================
// 3. PATRIMOINE PHYSIQUE (Long Terme)
// ==========================================

model Property {
  id          String   @id @default(cuid())
  title       String
  description String?
  address     String
  commune     String
  price       Int      // Loyer de référence (Mensuel)
  type        PropertyType
  bedrooms    Int
  bathrooms   Int
  surface     Float?
  images      String[]
  isPublished Boolean  @default(true)
  
  ownerId     String
  owner       User     @relation("PropertyOwner", fields: [ownerId], references: [id])
  
  // Relations Gestion
  leases      Lease[]
  incidents   Incident[]
  missions    Mission[]
  inventories Inventory[]

  // Relation avec l'Agence SaaS (Optionnel)
  agencyId    String?
  agency      Agency?  @relation(fields: [agencyId], references: [id])

  // Lien vers le Court Terme (Si ce bien est aussi sur Airbnb)
  listings    Listing[] 

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==========================================
// 4. GESTION LOCATIVE (Baux, États des lieux)
// ==========================================

model Lease {
  id              String          @id @default(cuid())
  startDate       DateTime
  endDate         DateTime?
  monthlyRent     Int
  depositAmount   Int
  status          LeaseStatus     @default(PENDING)
  isActive        Boolean         @default(false)
  
  // Légal
  contractUrl     String?
  documentHash    String?
  signatureStatus SignatureStatus @default(PENDING)
  
  tenantId        String
  tenant          User            @relation(fields: [tenantId], references: [id])
  propertyId      String
  property        Property        @relation(fields: [propertyId], references: [id])
  
  payments        Payment[]
  signatures      SignatureProof[]
  inventories     Inventory[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model Inventory {
  id          String        @id @default(cuid())
  date        DateTime      @default(now())
  type        MissionType   // ENTREE ou SORTIE
  notes       String?
  reportUrl   String?
  
  leaseId     String
  lease       Lease         @relation(fields: [leaseId], references: [id])
  propertyId  String
  property    Property      @relation(fields: [propertyId], references: [id])
  agentId     String?       // L'agent responsable
  
  items       InventoryItem[]
}

model InventoryItem {
  id          String   @id @default(cuid())
  roomName    String   // ex: "Cuisine"
  element     String   // ex: "Mur"
  condition   String   // ex: "Bon"
  comment     String?
  photos      String[]
  
  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id])
}

model SignatureProof {
  id        String   @id @default(cuid())
  ipAddress String
  signedAt  DateTime @default(now())
  userAgent String?
  otpToken  String?
  
  leaseId   String
  lease     Lease    @relation(fields: [leaseId], references: [id])
  signerId  String
  signer    User     @relation(fields: [signerId], references: [id])
}

// ==========================================
// 5. RÉSERVATION COURT SÉJOUR (Airbnb-like)
// ==========================================

model Listing {
  id             String   @id @default(cuid())
  title          String
  description    String   @db.Text
  
  pricePerNight  Int      // FCFA
  
  // Localisation précise (Maps)
  address        String
  city           String
  neighborhood   String?
  latitude       Float?
  longitude      Float?
  landmark       String?
  bedrooms       Int      @default(1)
  bathrooms      Int      @default(1)
  maxGuests      Int      @default(2)
  
  images         String[]
  amenities      Json     // { wifi: true, pool: false ... }
  accessVideoUrl String?  // Vidéo Youtube/S3 pour trouver les clés

  isPublished    Boolean  @default(false)

  // Relations
  hostId         String
  host           User     @relation(fields: [hostId], references: [id])
  
  agencyId       String?  // Si géré par une agence SaaS
  agency         Agency?  @relation(fields: [agencyId], references: [id])

  propertyId     String?  // Lien optionnel avec le bien physique (Long terme)
  property       Property? @relation(fields: [propertyId], references: [id])
  
  bookings       Booking[]
  reviews        Review[]

  wishlists      Wishlist[]       // Qui a mis ce bien en favori ?
  conversations  Conversation[]   // Discussions liées à ce bien

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Booking {
  id          String        @id @default(cuid())
  startDate   DateTime
  endDate     DateTime
  totalPrice  Int
  status      BookingStatus @default(PENDING)

  guestId     String
  guest       User          @relation(fields: [guestId], references: [id])
  
  listingId   String
  listing     Listing       @relation(fields: [listingId], references: [id])

  payment     BookingPayment?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id])
  
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())
}

// ==========================================
// 6. FINANCE & PAIEMENTS (Séparés)
// ==========================================

// A. Paiements Longue Durée (Loyers, Splits)
model Payment {
  id             String        @id @default(cuid())
  amount         Int          
  date           DateTime      @default(now())
  type           PaymentType
  status         PaymentStatus @default(PENDING)
  method         String?       // WAVE, ORANGE_MONEY
  reference      String?       // ID Transaction

  // Logique de Split
  amountOwner    Int           @default(0)
  amountPlatform Int           @default(0)
  amountAgent    Int           @default(0)

  leaseId        String
  lease          Lease         @relation(fields: [leaseId], references: [id])
}

// B. Paiements Courte Durée (Réservations)
model BookingPayment {
  id               String          @id @default(cuid())
  amount           Int
  provider         PaymentProvider // Enum spécifique gateway
  transactionId    String          @unique
  status           String
  
  agencyCommission Int
  hostPayout       Int

  bookingId        String          @unique
  booking          Booking         @relation(fields: [bookingId], references: [id])

  createdAt        DateTime        @default(now())
}

model Transaction {
  id          String   @id @default(cuid())
  amount      Int
  type        String   // CREDIT / DEBIT
  reason      String
  createdAt   DateTime @default(now())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
}

// ==========================================
// 7. OPÉRATIONS & MAINTENANCE
// ==========================================

model Mission {
  id            String        @id @default(cuid())
  type          MissionType
  status        MissionStatus @default(PENDING)
  fee           Int
  dateScheduled DateTime?
  reportData    String?
  
  propertyId    String
  property      Property      @relation(fields: [propertyId], references: [id])
  agentId       String?
  agent         User?         @relation("AgentMissions", fields: [agentId], references: [id])

  createdAt     DateTime      @default(now())
}

model Incident {
  id          String         @id @default(cuid())
  title       String
  description String
  priority    String         @default("NORMAL")
  photos      String[]
  status      IncidentStatus @default(OPEN)
  
  quoteAmount Int?
  finalCost   Int?
  
  reporterId  String
  reporter    User           @relation("IncidentReporter", fields: [reporterId], references: [id])
  
  assignedToId String?
  assignedTo   User?         @relation("ArtisanIncidents", fields: [assignedToId], references: [id])

  propertyId  String
  property    Property       @relation(fields: [propertyId], references: [id])

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model Lead {
  id        String   @id @default(cuid())
  name      String
  phone     String
  needs     String?
  budget    Int?
  status    String   @default("NEW")
  
  agentId   String?
  agent     User?    @relation(fields: [agentId], references: [id])

  createdAt DateTime @default(now())
}

// ==========================================
// ENUMS UNIFIÉS
// ==========================================

enum Role {
  SUPER_ADMIN   // Vous
  AGENCY_ADMIN  // Patron Agence SaaS
  ADMIN         // Admin système ImmoFacile
  OWNER         // Bailleur / Host
  TENANT        // Locataire Longue Durée
  GUEST         // Voyageur Courte Durée
  AGENT         // Agent Immo
  ARTISAN       // Prestataire
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum SignatureStatus {
  PENDING
  SIGNED_TENANT
  SIGNED_OWNER
  COMPLETED
}

enum PropertyType {
  APPARTEMENT
  VILLA
  STUDIO
  MAGASIN
  BUREAU
  TERRAIN
}

enum LeaseStatus {
  PENDING
  ACTIVE
  TERMINATED
  CANCELLED
}

enum BookingStatus {
  PENDING
  PAID
  CONFIRMED
  CHECKED_IN 
  COMPLETED
  CANCELLED
  DISPUTED
}

enum PaymentType {
  LOYER
  DEPOSIT
  CHARGES
  FEE
}

enum PaymentProvider {
  WAVE
  ORANGE_MONEY
  MTN_MOMO
  MOOV_MONEY
  STRIPE
  CASH
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum IncidentStatus {
  OPEN
  IN_PROGRESS
  QUOTATION
  RESOLVED
  CLOSED
}

enum MissionStatus {
  PENDING
  ACCEPTED
  COMPLETED
  CANCELLED
}

enum MissionType {
  VISITE
  ETAT_DES_LIEUX_ENTREE
  ETAT_DES_LIEUX_SORTIE
  PHOTOS
}

// ==========================================
// 8. EXTENSIONS GUEST (Favoris & Messagerie)
// ==========================================

// ✅ Pour la page "Favoris"
model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, listingId]) // Un utilisateur ne peut liker qu'une fois le même bien
}

// ✅ Pour la page "Messages" (Chat Hôte <-> Voyageur)
model Conversation {
  id        String    @id @default(cuid())
  
  guestId   String
  guest     User      @relation("GuestConversations", fields: [guestId], references: [id])
  
  hostId    String
  host      User      @relation("HostConversations", fields: [hostId], references: [id])
  
  listingId String?   // Optionnel : Lier la conversation à un bien spécifique
  listing   Listing?  @relation(fields: [listingId], references: [id])

  messages  Message[]

  lastMessageAt DateTime @default(now())

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Message {
  id             String       @id @default(cuid())
  content        String       @db.Text
  isRead         Boolean      @default(false)
  
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id])

  createdAt      DateTime     @default(now())
}
